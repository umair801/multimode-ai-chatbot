<!-- extends "layout.html" means: "layout.html" is a parent file -->
{% extends 'layout.html' %}
{% block content %}

<div class="container-fluid mt-4">
    <div class="row">
        <div class="col-12">
            <h3><i class="bi bi-graph-up me-2"></i>Professional Data Analytics Dashboard</h3>
            <p class="text-muted">Upload and analyze datasets for client projects and business insights</p>
        </div>
    </div>
    
    <!-- Quick Stats -->
    <div class="row mb-4" id="quickStats" style="display: none;">
        <div class="col-md-3">
            <div class="card bg-primary text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4 id="totalRows">0</h4>
                            <p class="mb-0">Total Rows</p>
                        </div>
                        <i class="bi bi-table display-4 opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-success text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4 id="totalColumns">0</h4>
                            <p class="mb-0">Columns</p>
                        </div>
                        <i class="bi bi-list-ul display-4 opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-warning text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4 id="missingValues">0</h4>
                            <p class="mb-0">Missing Values</p>
                        </div>
                        <i class="bi bi-exclamation-triangle display-4 opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-info text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4 id="numericColumns">0</h4>
                            <p class="mb-0">Numeric Columns</p>
                        </div>
                        <i class="bi bi-123 display-4 opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- File Upload Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5><i class="bi bi-cloud-upload me-2"></i>Dataset Upload & Professional Analysis</h5>
                </div>
                <div class="card-body">
                    <div class="file-upload-area" id="dashboardFileUpload">
                        <i class="bi bi-cloud-upload display-4 text-muted mb-3"></i>
                        <h5>Upload Client Dataset</h5>
                        <p class="text-muted">Drag & drop or click to browse</p>
                        <p class="small text-muted">Supports: CSV, Excel (.xlsx), JSON • Max 10MB</p>
                        <input type="file" id="dashboardFileInput" class="d-none" accept=".csv,.xlsx,.json">
                    </div>
                    
                    <div id="uploadProgress" class="mt-3" style="display: none;">
                        <div class="progress">
                            <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                 role="progressbar" style="width: 0%"></div>
                        </div>
                        <small class="text-muted">Processing file...</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Data Preview -->
    <div class="row mb-4" id="dataPreviewSection" style="display: none;">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5><i class="bi bi-table me-2"></i>Data Preview</h5>
                    <button class="btn btn-sm btn-outline-primary" onclick="downloadProcessedData()">
                        <i class="bi bi-download me-1"></i>Download Processed
                    </button>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover" id="dataPreviewTable">
                            <thead class="table-dark"></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Visualizations -->
    <div class="row" id="visualizationSection" style="display: none;">
        <div class="col-md-6 mb-4">
            <div class="card">
                <div class="card-header">
                    <h6><i class="bi bi-bar-chart me-2"></i>Correlation Heatmap</h6>
                </div>
                <div class="card-body text-center">
                    <div id="correlationChart"></div>
                </div>
            </div>
        </div>
        
        <div class="col-md-6 mb-4">
            <div class="card">
                <div class="card-header">
                    <h6><i class="bi bi-pie-chart me-2"></i>Data Distribution</h6>
                </div>
                <div class="card-body text-center">
                    <div id="distributionChart"></div>
                </div>
            </div>
        </div>
        
        <div class="col-12 mb-4">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h6><i class="bi bi-graph-down me-2"></i>Custom Visualization</h6>
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-outline-primary" onclick="createCustomViz('scatter')">Scatter</button>
                        <button class="btn btn-outline-primary" onclick="createCustomViz('line')">Line</button>
                        <button class="btn btn-outline-primary" onclick="createCustomViz('bar')">Bar</button>
                    </div>
                </div>
                <div class="card-body">
                    <div id="customChart"></div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Data Insights -->
    <div class="row" id="insightsSection" style="display: none;">
        <div class="col-12">
            <div class="card-header">
                <h5><i class="bi bi-lightbulb me-2"></i>Professional Insights & Recommendations</h5>
            </div>
            <div class="card-body">
                <div id="aiInsights">
                    <div class="text-center text-muted">
                        <i class="bi bi-hourglass-split display-4"></i>
                        <p>Generating professional analysis...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>

<script>
class DataDashboard {
    constructor() {
        this.currentData = null;
        this.fileName = null;
        
        this.initializeFileUpload();
    }
    
    initializeFileUpload() {
        const fileUploadArea = document.getElementById('dashboardFileUpload');
        const fileInput = document.getElementById('dashboardFileInput');
        
        // Click to upload
        fileUploadArea.onclick = () => fileInput.click();
        
        // Drag and drop handlers
        fileUploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            fileUploadArea.classList.add('dragover');
        });
        
        fileUploadArea.addEventListener('dragleave', () => {
            fileUploadArea.classList.remove('dragover');
        });
        
        fileUploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            fileUploadArea.classList.remove('dragover');
            if (e.dataTransfer.files.length > 0) {
                this.processFile(e.dataTransfer.files[0]);
            }
        });
        
        fileInput.onchange = (e) => {
            if (e.target.files.length > 0) {
                this.processFile(e.target.files[0]);
            }
        };
    }
    
    async processFile(file) {
        this.fileName = file.name;
        
        // Show progress
        document.getElementById('uploadProgress').style.display = 'block';
        
        const formData = new FormData();
        formData.append('file', file);
        
        try {
            const response = await fetch('/upload', {
                method: 'POST',
                body: formData
            });
            
            const result = await response.json();
            
            if (result.success) {
                this.currentData = result;
                this.displayAnalysis(result);
                this.generateInsights(result);
                showToast('Data loaded successfully!', 'success');
            } else {
                showToast('Failed to process file', 'danger');
            }
            
        } catch (error) {
            showToast('Error processing file', 'danger');
        } finally {
            document.getElementById('uploadProgress').style.display = 'none';
        }
    }
    
    displayAnalysis(data) {
        // Update quick stats
        const analysis = data.analysis;
        document.getElementById('totalRows').textContent = analysis.shape[0];
        document.getElementById('totalColumns').textContent = analysis.shape[1];
        
        const totalMissing = Object.values(analysis.missing_values).reduce((a, b) => a + b, 0);
        document.getElementById('missingValues').textContent = totalMissing;
        
        const numericCols = Object.keys(analysis.numeric_summary).length;
        document.getElementById('numericColumns').textContent = numericCols;
        
        document.getElementById('quickStats').style.display = 'flex';
        
        // Display data preview
        this.displayDataPreview(analysis);
        
        // Display visualizations
        this.displayVisualizations(data);
    }
    
    displayDataPreview(analysis) {
        const table = document.getElementById('dataPreviewTable');
        const thead = table.querySelector('thead');
        const tbody = table.querySelector('tbody');
        
        // Create header
        thead.innerHTML = '<tr>' + analysis.columns.map(col => `<th>${col}</th>`).join('') + '</tr>';
        
        // Create sample rows (if numeric summary available)
        tbody.innerHTML = '';
        if (Object.keys(analysis.numeric_summary).length > 0) {
            const firstNumCol = Object.keys(analysis.numeric_summary)[0];
            const stats = analysis.numeric_summary[firstNumCol];
            
            tbody.innerHTML = `
                <tr class="table-info">
                    <td colspan="${analysis.columns.length}">
                        <small><em>Sample statistics for ${firstNumCol}: 
                        Mean: ${stats.mean?.toFixed(2)}, 
                        Std: ${stats.std?.toFixed(2)}, 
                        Min: ${stats.min}, 
                        Max: ${stats.max}</em></small>
                    </td>
                </tr>
            `;
        }
        
        document.getElementById('dataPreviewSection').style.display = 'block';
    }
    
    displayVisualizations(data) {
        // Correlation heatmap
        if (data.visualizations && data.visualizations.correlation) {
            document.getElementById('correlationChart').innerHTML = 
                `<img src="${data.visualizations.correlation}" class="img-fluid">`;
        }
        
        // Sample distribution chart using Plotly
        if (Object.keys(data.analysis.numeric_summary).length > 0) {
            const numericCols = Object.keys(data.analysis.numeric_summary);
            const firstCol = numericCols[0];
            const stats = data.analysis.numeric_summary[firstCol];
            
            const trace = {
                x: ['Min', 'Q1', 'Median', 'Q3', 'Max'],
                y: [stats.min, stats['25%'], stats['50%'], stats['75%'], stats.max],
                type: 'scatter',
                mode: 'lines+markers',
                line: {color: 'rgb(52, 152, 219)'},
                marker: {size: 8}
            };
            
            const layout = {
                title: `${firstCol} Distribution`,
                xaxis: {title: 'Quartiles'},
                yaxis: {title: 'Values'},
                margin: {t: 40, b: 40, l: 40, r: 40}
            };
            
            Plotly.newPlot('distributionChart', [trace], layout, {responsive: true});
        }
        
        document.getElementById('visualizationSection').style.display = 'block';
    }
    
    async generateInsights(data) {
        document.getElementById('insightsSection').style.display = 'block';
        
        // Prepare data summary for AI analysis
        const analysis = data.analysis;
        const summary = {
            filename: data.filename,
            shape: analysis.shape,
            columns: analysis.columns,
            missing_data: Object.entries(analysis.missing_values)
                .filter(([col, missing]) => missing > 0)
                .map(([col, missing]) => `${col}: ${missing} missing`),
            numeric_columns: Object.keys(analysis.numeric_summary),
            categorical_columns: Object.keys(analysis.categorical_summary)
        };
        
        // Create insights request
        const insightsPrompt = `
        Analyze this dataset and provide actionable insights:
        
        Dataset: ${summary.filename}
        Shape: ${summary.shape[0]} rows × ${summary.shape[1]} columns
        Columns: ${summary.columns.join(', ')}
        Missing data: ${summary.missing_data.join(', ') || 'None'}
        
        Please provide:
        1. Key findings and patterns
        2. Data quality assessment
        3. Recommended preprocessing steps
        4. Potential use cases for freelancing projects
        5. Suggestions for further analysis
        
        Keep it practical and actionable.
        `;
        
        try {
            // Send to AI for analysis (you'll need to implement this endpoint)
            const response = await fetch('/api/analyze', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    prompt: insightsPrompt,
                    data_summary: summary
                })
            });
            
            const insights = await response.json();
            document.getElementById('aiInsights').innerHTML = insights.content || 
                '<p class="text-muted">Analysis completed. Key insights would appear here based on your data.</p>';
                
        } catch (error) {
            document.getElementById('aiInsights').innerHTML = `
                <div class="alert alert-info">
                    <h6>Dataset Analysis Complete</h6>
                    <p>Your dataset has been successfully loaded with ${summary.shape[0]} rows and ${summary.shape[1]} columns.</p>
                    <p><strong>Columns:</strong> ${summary.columns.join(', ')}</p>
                    ${summary.missing_data.length > 0 ? `<p><strong>Data Quality:</strong> ${summary.missing_data.join(', ')}</p>` : ''}
                    <p>Use the chat interface to ask specific questions about this dataset.</p>
                </div>
            `;
        }
    }
}

function createCustomViz(chartType) {
    if (!dashboard.currentData) {
        showToast('Please upload data first', 'warning');
        return;
    }
    
    const analysis = dashboard.currentData.analysis;
    const numericCols = Object.keys(analysis.numeric_summary);
    
    if (numericCols.length < 2) {
        showToast('Need at least 2 numeric columns for visualization', 'warning');
        return;
    }
    
    const col1 = numericCols[0];
    const col2 = numericCols[1];
    
    // Create sample data points
    const sampleData = [];
    for (let i = 0; i < 50; i++) {
        const stats1 = analysis.numeric_summary[col1];
        const stats2 = analysis.numeric_summary[col2];
        sampleData.push({
            x: stats1.min + Math.random() * (stats1.max - stats1.min),
            y: stats2.min + Math.random() * (stats2.max - stats2.min)
        });
    }
    
    let trace, layout;
    
    switch(chartType) {
        case 'scatter':
            trace = {
                x: sampleData.map(d => d.x),
                y: sampleData.map(d => d.y),
                mode: 'markers',
                type: 'scatter',
                marker: {color: 'rgb(52, 152, 219)', size: 8}
            };
            layout = {
                title: `${col2} vs ${col1}`,
                xaxis: {title: col1},
                yaxis: {title: col2}
            };
            break;
            
        case 'line':
            trace = {
                x: sampleData.map((d, i) => i),
                y: sampleData.map(d => d.y),
                type: 'scatter',
                mode: 'lines',
                line: {color: 'rgb(46, 204, 113)'}
            };
            layout = {
                title: `${col2} Trend`,
                xaxis: {title: 'Index'},
                yaxis: {title: col2}
            };
            break;
            
        case 'bar':
            const bins = {};
            sampleData.forEach(d => {
                const bin = Math.floor(d.x / 10) * 10;
                bins[bin] = (bins[bin] || 0) + 1;
            });
            
            trace = {
                x: Object.keys(bins),
                y: Object.values(bins),
                type: 'bar',
                marker: {color: 'rgb(231, 76, 60)'}
            };
            layout = {
                title: `${col1} Distribution`,
                xaxis: {title: col1},
                yaxis: {title: 'Frequency'}
            };
            break;
    }
    
    Plotly.newPlot('customChart', [trace], layout, {responsive: true});
}

function downloadProcessedData() {
    if (!dashboard.currentData) return;
    
    const processedData = {
        filename: dashboard.fileName,
        analysis: dashboard.currentData.analysis,
        processed_at: new Date().toISOString(),
        recommendations: "See AI insights for detailed recommendations"
    };
    
    const blob = new Blob([JSON.stringify(processedData, null, 2)], {type: 'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `processed_${dashboard.fileName.split('.')[0]}.json`;
    a.click();
    URL.revokeObjectURL(url);
}

// Initialize dashboard
let dashboard;
document.addEventListener('DOMContentLoaded', () => {
    dashboard = new DataDashboard();
});
</script>

{% endblock %}